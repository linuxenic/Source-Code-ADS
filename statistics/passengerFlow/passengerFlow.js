var showTerminal,showTerminalDetail,removeTerminal,sendOrder,showScreenWin,shutdownFn,showMoreFn,viewTimerWinow,isFreshing=true,freshPlanTimeout,isPlanfresh=false,moreMenuCmp;var clientWindth=$(window.top).width();var clientHeight=$(window.top).height();Ext.onReady(function(){parent.parent.closeThreadRdnum=rdnum;Ext.QuickTips.init();var nowEndDate=new Date();nowEndDate.setHours(23,59,59);var yesterdayBegin=new Date();yesterdayBegin.setDate(yesterdayBegin.getDate()-1);yesterdayBegin.setHours(0,0,0);var yesterdayEnd=new Date();yesterdayEnd.setDate(yesterdayEnd.getDate()-1);yesterdayEnd.setHours(23,59,59);var nowBeginDate=new Date();nowBeginDate.setHours(0,0,0);var viewport,timeId,chartPanel,viewTable_prefix="view_ul",ajaxProxy,datastore,btime,etime,webpath=getWebPath(),diskinfoChangeFn,diskinfoMap=new Ext.util.HashMap(),terAview="terA_view";var filterObj={name:"",sortKey:"name",sortVal:"ASC"};var commonTimeoutId,autoFresh=true,tplItem,tplshutItem;var AUTH=Ext.merge({screen:false,off:false,"delete":false,play:false,pub:false,restart:false},Ext.decode(decode(AUTH_TBAR)));var force="check";var groupStore=Ext.create("Ext.data.Store",{fields:["gid","gname"],autoLoad:true,timeout:300000,proxy:{type:"ajax",url:"terminal!selTerminalGroupList.action",reader:{type:"json",root:"data",totalProperty:"totalCount"}},listeners:{load:function(){this.loadData([{gid:-1,gname:"- -"+getIi18NText("allTerminalTeams")+"- -"}],true)}}});tabStore=Ext.create("Ext.data.Store",{fields:["tid","tname","tip","screen","groupName","flowNum","averageFlow","maxFlowDay","remark"],buffered:false,pageSize:10,proxy:{type:"ajax",url:"passengerflow!passengerFlowList.action",timeout:1800000,reader:{type:"json",root:"data",timeout:300000,totalProperty:"totalCount"}},autoLoad:false,listeners:{load:function($this,model){Ext.getBody().unmask()}}});function checkDataCount(parm){parent.document.body;Ext.getBody().mask(getIi18NText("monitor_message_58"));var result=true;Ext.Ajax.request({url:"passengerflow!passengerFlowList.action",params:{w:parm.w,g:parm.g,n:parm.n,b:parm.b,e:parm.e,ext:"ext",force:force,},success:function(response){var r=Ext.decode(response.responseText);result=r.hasError;if(typeof(result)!="undefined"&&!result){Ext.Msg.show({icon:Ext.MessageBox.QUESTION,title:getIi18NText("systemMessage"),cls:"msgCls",msg:getIi18NText("rangeChooseTip"),plain:true,buttons:Ext.MessageBox.OKCANCEL,buttonText:{ok:getIi18NText("continue"),cancel:getIi18NText("cancel")},fn:function(bid,text,opt){if(bid=="ok"){force=true;queryFun(true)}}})}}});Ext.getBody().unmask();return result}var chart=Ext.create("Ext.chart.Chart",{store:tabStore,axes:[{type:"Numeric",position:"left",fields:["flowNum"],label:{renderer:Ext.util.Format.numberRenderer("0,0")},title:getIi18NText("passengerFlow"),grid:true,minimum:0},{type:"Category",position:"bottom",fields:["tname"],title:getIi18NText("terminalName")}],series:[{type:"column",axis:"left",highlight:true,tips:{trackMouse:true,width:140,height:28,renderer:function(storeItem,item){this.setTitle(storeItem.get("tname")+": "+storeItem.get("flowNum"))}},label:{display:"insideEnd","text-anchor":"middle",field:"flowNum",renderer:Ext.util.Format.numberRenderer("0"),orientation:"horizontal",color:"#333"},xField:"tname",yField:"flowNum"}]});viewport=Ext.create("Ext.container.Viewport",{layout:"border",renderTo:document.body,border:false,items:[{region:"north",height:40,width:400,id:"northContanier",layout:{type:"hbox",align:"middle",defaultMargins:{right:3}},bodyCls:"x_panel_backDD",items:[{xtype:"image",src:"",width:40,height:24,imgCls:"searchIconCss",},{xtype:"combo",fieldLabel:getIi18NText("onTerms"),labelWidth:40,width:125,editable:false,id:"switchCombo",store:[[1,getIi18NText("terminalTeam")],[3,getIi18NText("terminalName")]],queryMode:"local",displayField:"name",valueField:"value",value:1,listeners:{change:function($this,newValue,oldValue,eOpts){condEvent($this,newValue,oldValue,eOpts)},afterRender:queryFun}},{xtype:"combo",labelWidth:40,id:"allGroup_combo",width:130,editable:false,store:groupStore,queryMode:"local",displayField:"gname",valueField:"gid",value:-1},{fieldLabel:getIi18NText("name"),id:"searchTextId",xtype:"textfield",hidden:true,maxLength:50,width:130,labelWidth:30,emptyText:getIi18NText("keyword"),enforceMaxLength:true},{xtype:"datefield",fieldLabel:getIi18NText("beCreatedTimne"),hidden:false,format:dateFormat,labelWidth:80,width:270,id:"btime",name:"btime",emptyText:getIi18NText("startTime"),value:nowBeginDate},{xtype:"datefield",id:"etime",hidden:false,format:dateFormat,width:180,emptyText:getIi18NText("endTime"),value:nowEndDate,listeners:{select:function($this){var temdate=$this.getValue();temdate.setHours(23,59,59);$this.setValue(temdate)}}},{xtype:"button",id:"queryBut",text:window.top.getIi18NText("selectAndRefresh"),handler:queryFun}]},{region:"center",border:false,layout:"fit",listeners:{afterrender:renderTable}},{region:"south",height:200,border:false,layout:"fit",items:[chart]}]});function renderTable($this,eopt){gridPanel=Ext.create("Ext.grid.Panel",{frame:false,store:tabStore,columns:{items:[{text:getIi18NText("No"),width:50,xtype:"rownumberer",align:"center"},{text:getIi18NText("terminalName"),dataIndex:"tname",flex:2,align:"center"},{text:getIi18NText("passengerFlow"),dataIndex:"flowNum",minWidth:200,flex:2,align:"center",renderer:openTerminalWin},{text:getIi18NText("MaxPassengerFlow"),dataIndex:"maxFlowDay",align:"center",flex:2},{text:getIi18NText("AvgPassengerFlow"),dataIndex:"averageFlow",flex:2,align:"center"}],defaults:{menuDisabled:true,sortable:false}},bbar:[Ext.create("Ext.PagingToolbar",{id:"padingBar",store:tabStore,displayInfo:true,border:false,displayMsg:getIi18NText("jsp_paging"),emptyMsg:getIi18NText("jsp_nodata")})],margin:1,viewConfig:{trackOver:false,disableSelection:false,emptyText:'<h1 style="margin:10px">'+window.top.getIi18NText("roleTip05")+"</h1>"}});$this.add(gridPanel)}function exitModifyProgramFn(t){var r=confirm(getIi18NText("exitWaraming01"));return r}function openTerminalPassengerFlow(N){if(parent&&parent.addTabManFn){parent.addTabManFn({id:"tid_"+N.id+N.b+N.e,title:window.top.getIi18NText("terminalPassengerFlowInfo")+"("+N.tname+")",iconCls:"createIconCss",closable:true,closeText:window.top.getIi18NText("cancelModify"),listeners:{beforeclose:exitModifyProgramFn},html:'<iframe frameborder="0" width="100%" height="100%" src="passengerflow!showTerminalPassengerflow.action?tid='+N.id+"&&tname="+N.tname+"&&b="+Ext.Date.format(btime,dateFormat)+"&&e="+Ext.Date.format(etime,dateFormat)+'"></iframe>',border:false})}}var toolTips=Ext.create("Ext.tip.ToolTip",{html:""});function getMousePos(event){var e=event||window.event;var scrollX=document.documentElement.scrollLeft||document.body.scrollLeft;var scrollY=document.documentElement.scrollTop||document.body.scrollTop;var x=e.pageX||e.clientX+scrollX;var y=e.pageY||e.clientY+scrollY;return[x+35,y]}function showDate(comp,N,e){var html="<div id="+N.id+' align="center"><font color="#FF9393">'+getIi18NText("terminalInfo")+" </font></div><div >"+getIi18NText("terminalName")+":"+N.tname+"</div><div >"+getIi18NText("screen")+":"+N.screen+"</div><div >"+getIi18NText("terminalTeam")+":"+N.group+"</div><div >"+getIi18NText("IP")+":"+N.ip+"</div>";toolTips.update(html);toolTips.showAt(getMousePos(e));if(comp){comp.addListener("mouseout",function(){toolTips.hide()})}}showTerminal=function(r){var model=gridPanel.getStore().getAt(r);if(model){var tid=model.get("tid");var tname=model.get("tname");var ip=model.get("tip");var group=model.get("groupName");var screen=model.get("screen");openTerminalPassengerFlow({id:tid,tname:tname,b:Ext.Date.format(btime,"YmdHis"),e:Ext.Date.format(etime,"YmdHis")})}};function openTerminalWin(value,metaData,record,rIndex,cIndex){return Ext.String.format('<a href="javascript: showTerminal('+rIndex+');">{0}</a>',Ext.String.htmlEncode(value))}function condEvent($this,newValue,oldValue,eOpts){if(oldValue==1){Ext.getCmp("allGroup_combo").hide().getEl().fadeOut()}else{if(oldValue==2){Ext.getCmp("allCompany_combo").hide().getEl().fadeOut()}else{if(oldValue==3){Ext.getCmp("searchTextId").hide().getEl().fadeOut()}}}if(newValue==1){Ext.getCmp("allGroup_combo").show().getEl().fadeIn()}else{if(newValue==2){Ext.getCmp("allCompany_combo").show().getEl().fadeIn()}else{if(newValue==3){Ext.getCmp("searchTextId").show().getEl().fadeIn()}}}}function queryFun(forceQuery){if(forceQuery!=true){force="check"}isFreshing=false;var way=Ext.getCmp("switchCombo").getValue();var group=Ext.getCmp("allGroup_combo").getValue();var name=Ext.getCmp("searchTextId").getValue();btime=Ext.getCmp("btime").getValue();etime=Ext.getCmp("etime").getValue();if(btime>etime&&etime){Ext.example.msg(getIi18NText("operationTips"),'<font color="red">'+getIi18NText("programTip04")+"</font>");return}var cutDy=(etime-btime)/(1000*60*60*24);if(cutDy>360){Ext.example.msg(getIi18NText("operationTips"),'<font color="red">'+getIi18NText("operationRangeTips")+"</font>");return}if(!tabStore.hasListener("beforeload")){tabStore.on("beforeload",function(store,options){var new_params={w:Ext.getCmp("switchCombo").getValue(),g:Ext.getCmp("allGroup_combo").getValue(),n:encode(Ext.getCmp("searchTextId").getValue()),b:Ext.Date.format(Ext.getCmp("btime").getValue(),dateFormat),e:Ext.Date.format(Ext.getCmp("etime").getValue(),dateFormat),rd:rdnum};Ext.apply(store.proxy.extraParams,new_params);return checkDataCount(new_params)})}if(forceQuery&&forceQuery==true){tabStore.getProxy().setExtraParam("force","force")}else{tabStore.getProxy().setExtraParam("force","")}tabStore.loadPage(1,function(records,operation,success){if(success==false){isFreshing=false;alert(getIi18NText("monitor_error_01"));return}isFreshing=true})}function exportStatistics(){if(tabStore.data.length==0){Ext.Msg.alert(getIi18NText("systemMessage"),getIi18NText("jsp_noExportData"));return}Ext.getBody().mask(getIi18NText("monitor_message_58"));params=tabStore.proxy.extraParams;Ext.Ajax.request({url:"statistics!exportStatisticsData.action",timeout:36000000,params:params,success:function(response){Ext.getBody().unmask();var text=eval("("+response.responseText+")");if(text.code=="0"){window.location.href=getWebPath()+"/page/statistics/statistics/export/"+text.msg}else{Ext.Msg.alert(getIi18NText("systemMessage"),text.msg);return}},failure:function(response){Ext.Msg.alert(getIi18NText("systemMessage"),getIi18NText("timeout"));Ext.getBody().unmask()}})}});