var showTerminal,showTerminalDetail,isFreshing=true,freshPlanTimeout,isPlanfresh=false;Ext.onReady(function(){Ext.QuickTips.init();var gridPanel,tabStore,ajaxProxy;var goodsName="static_goods_name",payType="static_pay_type";var isEng=getIi18NText("confirm")=="OK"?true:false;var viewport,webpath=getWebPath();var chartPanel;var chartDay,chartMonth;Ext.define("StoreStat",{extend:"Ext.data.Model",fields:["toPrice","date","orNum"]});var date=new Date();var month=(date.getMonth()+1);var day=date.getDate();if((date.getMonth()+1)<10){month="0"+(date.getMonth()+1)}if(date.getDate()<10){day="0"+date.getDate()}var current=date.getFullYear()+"/"+month+"/"+day+" 23:59:59";var currentBegin=date.getFullYear()+"/"+month+"/01 00:00:00";var defaultBeTime=new Date();defaultBeTime.setDate(1);var groupStore=Ext.create("Ext.data.Store",{fields:["gid","gname"],autoLoad:true,proxy:{type:"ajax",url:"terminal!selTerminalGroupList.action",reader:{type:"json",root:"data",tiemout:30000,totalProperty:"totalCount"}},listeners:{load:function(){this.loadData([{gid:-1,gname:"- -"+getIi18NText("allTerminalTeams")+"- -"}],true)}}});getSaleInfos({way:"-1",gid:"",tname:"",b:currentBegin,e:current,type:"2",gname:"",payWay:0});var dayStore=Ext.create("Ext.data.Store",{fields:[{name:"toPrice",type:"float"},{name:"date",type:"string"}],buffered:false,pageSize:30,proxy:{type:"ajax",url:"statistics!getStatisticsForSale.action",extraParams:{way:"-1",gid:"",tname:"",b:currentBegin,e:current,type:"0",gname:"",payWay:0},reader:{type:"json",root:"data",tiemout:30000,totalProperty:"totalCount"}},autoLoad:true,listeners:{load:function($this){Ext.getBody().unmask()}}});var monthStore=Ext.create("Ext.data.Store",{fields:[{name:"toPrice",type:"float"},{name:"date",type:"string"}],buffered:false,pageSize:30,proxy:{type:"ajax",url:"statistics!getStatisticsForSale.action",extraParams:{way:"-1",gid:"",tname:"",b:currentBegin,e:current,type:"1",gname:"",payWay:0},reader:{type:"json",root:"data",tiemout:30000,totalProperty:"totalCount"}},autoLoad:true,listeners:{load:function($this){Ext.getBody().unmask()}}});chartDay=Ext.create("Ext.chart.Chart",{store:dayStore,legend:true,axes:[{title:getIi18NText("income"),type:"Numeric",position:"left",fields:["toPrice"],label:{renderer:Ext.util.Format.numberRenderer("00.00")},grid:false,minimum:0},{type:"Category",position:"bottom",fields:["date"],title:getIi18NText("time"),label:{rotate:{degrees:45}}}],series:[{title:getIi18NText("income"),type:"line",axis:"left",xField:"date",yField:"toPrice",smooth:true,highlight:{size:5,radius:5},tips:{trackMouse:true,width:180,height:28,renderer:function(storeItem,item){this.setTitle(storeItem.get("date")+" "+getIi18NText("income")+":￥"+storeItem.get("toPrice"))}}}]});chartMonth=Ext.create("Ext.chart.Chart",{store:monthStore,legend:true,axes:[{title:getIi18NText("income"),type:"Numeric",position:"left",fields:["toPrice"],label:{renderer:Ext.util.Format.numberRenderer("00.00")},grid:false,minimum:0},{type:"Category",position:"bottom",fields:["date"],title:getIi18NText("time"),label:{rotate:{degrees:45}}}],series:[{title:getIi18NText("income"),type:"line",axis:"left",xField:"date",yField:"toPrice",smooth:true,highlight:{size:5,radius:5},tips:{trackMouseOver:true,width:180,height:28,renderer:function(storeItem,item){this.setTitle(storeItem.get("date")+" "+getIi18NText("income")+":￥"+storeItem.get("toPrice"))}}}]});viewport=Ext.create("Ext.container.Viewport",{id:"panelBoss",layout:"vbox",border:false,width:"100%",overflowY:"auto",items:[{xtype:"panel",id:"panelFirst",height:80,width:"100%",border:false,layout:{type:"vbox",align:"middle",defaultMargins:{right:3}},bodyCls:"x_panel_backDD",items:[{xtype:"panel",layout:"hbox",width:"100%",bodyCls:"x_panel_backDD",defaults:{margin:"8 2 5 3"},border:false,items:[{xtype:"image",margin:"8 2 5 10",src:"",width:40,height:24,imgCls:"searchIconCss",},{xtype:"combo",fieldLabel:getIi18NText("onTerms"),labelWidth:isEng?20:40,width:140,editable:false,id:"switchCombo",store:[[1,getIi18NText("terminalTeam")],[3,getIi18NText("terminalName")]],queryMode:"local",displayField:"name",valueField:"value",value:1,listeners:{change:function($this,newValue,oldValue,eOpts){condEvent($this,newValue,oldValue,eOpts)}}},{xtype:"combo",labelWidth:40,id:"allGroup_combo",width:130,editable:false,store:groupStore,queryMode:"local",displayField:"gname",valueField:"gid",value:-1},{xtype:"textfield",fieldLabel:getIi18NText("name"),id:"searchTextId",hidden:true,maxLength:50,width:130,labelWidth:30,emptyText:getIi18NText("keyword"),enforceMaxLength:true},{xtype:"datefield",fieldLabel:getIi18NText("time"),margin:"8 2 5 20",hidden:false,format:"Y/m/d",labelWidth:30,width:200,id:"btime",name:"btime",emptyText:getIi18NText("startTime"),value:defaultBeTime},{xtype:"datefield",id:"etime",hidden:false,format:"Y/m/d",width:170,emptyText:getIi18NText("endTime"),value:new Date()}]},{xtype:"panel",layout:"hbox",width:"100%",bodyCls:"x_panel_backDD",defaults:{margin:"8 2 5 3"},border:false,items:[{xtype:"textfield",margin:"8 2 5 55",fieldLabel:getIi18NText("goods_nm"),id:goodsName,width:230,labelWidth:isEng?80:40,emptyText:getIi18NText("queryByGoodsName")},{xtype:"combo",fieldLabel:getIi18NText("gd_pay_type"),margin:"8 2 5 25",store:new Ext.data.SimpleStore({fields:["key","value"],data:[["0",getIi18NText("allPayWay")],["2",getIi18NText("wechat_way")],["3",getIi18NText("alipay_way")],["11",getIi18NText("OctopusPay")],["12",getIi18NText("youZanPay")],["13",getIi18NText("cashPay")],["16",getIi18NText("jdPay")]]}),displayField:"value",valueField:"key",queryMode:"local",editable:false,name:"payType",id:payType,width:170,labelWidth:55,value:"0",listeners:{change:function($this,newValue,oldValue,eOpts){}}},{xtype:"button",margin:"8 2 5 200",text:window.top.getIi18NText("selectAndRefresh"),handler:queryFun},{xtype:"displayfield",id:"terminalAmount",fieldLabel:window.top.getIi18NText("currentTerAmount"),fieldStyle:"color:red;font-size:14px;",labelWidth:getIi18NText("confirm")=="OK"?100:110,margin:"8 2 5 10",width:200}]}]},{xtype:"panel",height:45,width:"100%",layout:"hbox",border:false,defaults:{margin:"20 0 0 0"},items:[{xtype:"displayfield",id:"monthSale",fieldLabel:window.top.getIi18NText("salesSum"),labelStyle:"font-size:15px;font-family:bold;font-weight:bold;",labelWidth:getIi18NText("confirm")=="OK"?90:70,margin:"20 0 0 30",width:160},{xtype:"displayfield",id:"todaySale",fieldLabel:window.top.getIi18NText("dayAveSales"),labelStyle:"font-size:15px;font-family:bold;font-weight:bold;",labelWidth:getIi18NText("confirm")=="OK"?110:70,width:180},{xtype:"displayfield",id:"monthTerminalSale",fieldLabel:window.top.getIi18NText("monthSaleFirstTreminal"),labelStyle:"font-size:15px;font-family:bold;font-weight:bold;",labelWidth:getIi18NText("confirm")=="OK"?175:120,width:360},{xtype:"displayfield",fieldLabel:window.top.getIi18NText("monthSaleFirstGoods"),labelStyle:"font-size:15px;font-family:bold;font-weight:bold;",id:"monthGoodsSale",labelWidth:getIi18NText("confirm")=="OK"?155:110,margin:"20 0 0 2",width:290}]},{xtype:"panel",height:100,width:"100%",layout:"hbox",border:false,items:[{xtype:"displayfield",id:"salesCost",fieldLabel:window.top.getIi18NText("netProfit"),labelStyle:"font-size:15px;font-family:bold;font-weight:bold;",labelWidth:getIi18NText("confirm")=="OK"?90:70,margin:"10 0 0 30",width:160}]},{xtype:"panel",height:250,width:"100%",border:false,layout:"fit",listeners:{render:renderTable}},{xtype:"panel",height:50,width:"100%",border:false,layout:"fit",items:[{xtype:"displayfield",fieldLabel:getIi18NText("dailyIncome"),labelWidth:70,margin:"20 0 0 40",width:100}]},{xtype:"panel",border:false,height:400,width:"100%",layout:"fit",items:[chartDay]},{height:30,width:"100%",border:false,layout:{type:"hbox",align:"middle",defaultMargins:{right:3}},items:[{xtype:"displayfield",fieldLabel:getIi18NText("monthIncome"),labelWidth:70,margin:"0 0 0 40",width:100}]},{xtype:"panel",border:false,height:400,width:"100%",layout:"fit",items:[chartMonth]}]});function getSaleInfos(obj){Ext.Ajax.request({method:"POST",url:"statistics!getStatisticsForSale.action",dataType:"json",params:obj,reader:{type:"json",root:"data",tiemout:60000,totalProperty:"totalCount"},success:function(response){var data=response.responseText;var obj=eval("("+data+")");var result=obj.data;if(result){Ext.getCmp("monthSale").setValue(result.sumSales);Ext.getCmp("todaySale").setValue(result.dayAverageSales);var width=(isEng==true?175:230);Ext.getCmp("monthTerminalSale").setValue('<div id="monthTerminalSale-value" style="width:'+width+'px;overflow-x:scroll;">'+result.terRank1+"</div>");width=125;Ext.getCmp("monthGoodsSale").setValue('<div id="monthGoodsSale-value" style="width:'+width+'px;overflow-x:scroll;">'+result.goodRank1+"</div>");Ext.getCmp("terminalAmount").setValue(result.terminalCount);Ext.getCmp("salesCost").setValue(result.salesCost)}}})}function renderTable($this,eopt){ajaxProxy=getAjaxProxy({url:"statistics!getStatisticsForSale.action",extraParams:{way:"-1",gid:"",tname:"",b:currentBegin,e:current,type:"3",gname:"",payWay:0}});tabStore=Ext.create("Ext.data.Store",{fields:["terNo","terName","goodsName","goodsSale","totalSales","profits","goodsCount","groupName"],buffered:false,autoLoad:true,pageSize:20,leadingBufferZone:50,proxy:ajaxProxy,remoteSort:true,listeners:{load:function($this){Ext.getBody().unmask()}}});gridPanel=Ext.create("Ext.grid.Panel",{height:300,store:tabStore,columns:{items:[{text:window.top.getIi18NText("No"),width:60,xtype:"rownumberer",align:"center"},{text:window.top.getIi18NText("quipmentNo"),dataIndex:"terNo",width:80,align:"center"},{text:window.top.getIi18NText("deviceName"),dataIndex:"terName",minWidth:120,align:"center",sortable:true},{text:getIi18NText("device")+" "+getIi18NText("salesSum")+"("+getIi18NText("rmb")+")",dataIndex:"totalSales",minWidth:120,align:"center",sortable:true},{text:window.top.getIi18NText("netProfit")+"("+getIi18NText("rmb")+")",dataIndex:"profits",minWidth:isEng==true?110:80,align:"center",sortable:true},{text:getIi18NText("topSalesVolumeOfGoods"),dataIndex:"goodsName",minWidth:isEng==true?170:100,align:"center",flex:1},{text:getIi18NText("topSalesVolumeOfGoodsAmount")+"("+getIi18NText("rmb")+")",dataIndex:"goodsSale",minWidth:150,align:"center"},{text:getIi18NText("topSalesVolumeOfNum"),dataIndex:"goodsCount",width:100,align:"center"},{text:window.top.getIi18NText("terminalTeam"),dataIndex:"groupName",minWidth:120,align:"center"},],defaults:{menuDisabled:true,sortable:false}},bbar:[{id:"padingBar",xtype:"pagingtoolbar",store:tabStore,border:false,displayInfo:true}],margin:"1",viewConfig:{trackOver:true,disableSelection:true,emptyText:'<h1 style="margin:10px; font-size: 18px;">'+getIi18NText("item_noresult")+"</h1>"}});$this.add(gridPanel)}function condEvent($this,newValue,oldValue,eOpts){if(oldValue==1){Ext.getCmp("allGroup_combo").hide()}else{if(oldValue==2){Ext.getCmp("allCompany_combo").hide()}else{if(oldValue==3){Ext.getCmp("searchTextId").hide();Ext.getCmp("searchTextId").setValue("")}}}if(newValue==1){Ext.getCmp("allGroup_combo").show()}else{if(newValue==2){Ext.getCmp("allCompany_combo").show()}else{if(newValue==3){Ext.getCmp("searchTextId").show()}}}}function queryFun(isCurrent){var btme=Ext.getCmp("btime");var etme=Ext.getCmp("etime");if(!btme.isValid()){Ext.example.msg(getIi18NText("operationTips"),'<font color="red">'+getIi18NText("item_set_starttime")+"</font>");return}if(!etme.isValid()){Ext.example.msg(getIi18NText("operationTips"),'<font color="red">'+getIi18NText("item_set_endtime")+"</font>");return}if(btme.getValue()>etme.getValue()){Ext.example.msg(getIi18NText("operationTips"),'<font color="red">'+getIi18NText("item_timeerror")+"</font>");return}if(btme.getValue()){var cutDy=(etme.getValue()-btme.getValue())/(1000*60*60*24);if(cutDy>180){Ext.example.msg(getIi18NText("operationTips"),'<font color="red">'+getIi18NText("noMore180")+"</font>");return}}btme=btme.getValue();btme.setHours(0,0,0);etme=etme.getValue();etme.setHours(23,59,59);var name=Ext.getCmp("searchTextId").getValue();name=encodeURI(name).replace(/\+/g,"%2B");var way=Ext.getCmp("switchCombo").getValue();var gid=Ext.getCmp("allGroup_combo").getValue();var gname=Ext.getCmp(goodsName).getValue();gname=encodeURI(gname).replace(/\+/g,"%2B");var payWay=Ext.getCmp(payType).getValue();getSaleInfos({way:way,gid:gid,tname:name,b:Ext.Date.format(btme,dateFormat),e:Ext.Date.format(etme,dateFormat),type:2,gname:gname,payWay:payWay});ajaxProxy.setExtraParam("way",way);ajaxProxy.setExtraParam("gid",gid);ajaxProxy.setExtraParam("tname",name);ajaxProxy.setExtraParam("b",Ext.Date.format(btme,dateFormat));ajaxProxy.setExtraParam("e",Ext.Date.format(etme,dateFormat));ajaxProxy.setExtraParam("type",3);ajaxProxy.setExtraParam("gname",gname);ajaxProxy.setExtraParam("payWay",payWay);tabStore.loadPage(1);dayStore.load({params:{way:way,gid:gid,tname:name,b:Ext.Date.format(btme,dateFormat),e:Ext.Date.format(etme,dateFormat),type:0,gname:gname,payWay:payWay},callback:function(records,operation,success){if(success==false){alert(getIi18NText("monitor_error_01"));return}}});monthStore.load({params:{way:way,gid:gid,tname:name,b:Ext.Date.format(btme,dateFormat),e:Ext.Date.format(etme,dateFormat),type:1,gname:gname,payWay:payWay},callback:function(records,operation,success){if(success==false){alert(getIi18NText("monitor_error_01"));return}}})}function statusRender(value){if(value===1){return getIi18NText("jsp_success")}return"<span style='color:red;'>"+getIi18NText("jsp_fail")+"</span>"}$(".x-viewport").css("overflow","visible")});