var updatefirmware;Ext.onReady(function(){var viewport,gridPanel,gridRowFix="grid_row_fram_";var commonTip=Ext.create("Ext.tip.ToolTip",{title:getIi18NText("systemMessage"),minWidth:100,html:""});Ext.QuickTips.init();var AUTH=Ext.merge({add:false,"delete":false,showMore:true},Ext.decode(decode(AUTH_TBAR)));var tabStore=Ext.create("Ext.data.Store",{fields:["id","name","creator","versionType","isDefault","pubDate","remark"],pageSize:10,id:"firmwareStore",leadingBufferZone:50,autoLoad:true,proxy:{type:"ajax",url:"system!getFirmware.action",reader:{type:"json",root:"data",totalProperty:"totalCount"}}});var gridPanel=Ext.create("Ext.grid.Panel",{title:getIi18NText("firm_list"),iconCls:"tabIconCss",id:"firmwareGrid",frame:false,store:tabStore,columns:[{text:getIi18NText("No"),width:60,xtype:"rownumberer",align:"center"},{text:getIi18NText("jsp_version"),dataIndex:"name",flex:1,align:"center"},{text:getIi18NText("type"),dataIndex:"versionType",flex:1,align:"center",renderer:renderVersion},{text:getIi18NText("remarks"),dataIndex:"remark",flex:1,align:"center"},{text:getIi18NText("jsp_default"),dataIndex:"isDefault",flex:1,align:"center",renderer:renderDefault},{text:getIi18NText("operation"),dataIndex:"",flex:1,minWidth:165,renderer:renderOperation,align:"center"},{text:getIi18NText("jsp_publishDate"),dataIndex:"pubDate",flex:1,align:"center"},{text:getIi18NText("operator"),dataIndex:"creator",flex:1,align:"center"}],margin:1,tools:[{xtype:"button",tooltipType:"title",text:getIi18NText("jsp_pubNewVersion"),border:false,iconCls:"addIconCss",hidden:!AUTH.add,margin:"0 5 0 0",handler:function(event,toolEl){var form=addNewAppWin.down("form").getForm();form.reset();addNewAppWin.show()}},{xtype:"button",tooltipType:"title",text:getIi18NText("refresh"),border:false,iconCls:"refreshIconCss",handler:function(event,toolEl){tabStore.loadPage(1)}}],bbar:[{xtype:"pagingtoolbar",store:tabStore,border:false,displayInfo:true}]});viewport=Ext.create("Ext.container.Viewport",{layout:{type:"border"},renderTo:document.body,defaults:{},border:false,style:"background: white",items:[{region:"center",border:false,layout:"fit",items:[gridPanel],listeners:{}}]});var versionStore=Ext.create("Ext.data.Store",{fields:["version","value"],data:[{version:"RYXA83T_4.4",value:"1001"}],autoLoad:true});var versionMap=new Ext.util.HashMap();versionMap.add(1001,"RYXA83T_4.4");var addNewAppWin=Ext.create("Ext.window.Window",{title:getIi18NText("firm_add"),closeAction:"hide",width:400,layout:"fit",items:{xtype:"form",bodyPadding:5,width:350,url:"system!saveFirmware.action",layout:"anchor",defaults:{anchor:"100%",labelAlign:"right"},defaultType:"textfield",items:[{fieldLabel:"id",hidden:true,name:"id",allowBlank:true},{fieldLabel:getIi18NText("jsp_versionName"),name:"name",id:"versionName",maxLength:50,allowBlank:false},{fieldLabel:getIi18NText("type"),xtype:"combobox",name:"versionType",store:versionStore,value:"1001",queryMode:"local",displayField:"version",valueField:"value",allowBlank:false,editable:false,forceSelection:true,autoSelect:true},{fieldLabel:getIi18NText("remarks"),name:"remark",maxLength:50,value:Ext.Date.format(new Date(),"Y-m-d"),allowBlank:false},{xtype:"filefield",fieldLabel:getIi18NText("jsp_file"),buttonText:getIi18NText("jsp_browse"),name:"sourceFile",msgTarget:"side",allowBlank:false,validator:function(value){var arr=value.split(".");var text=arr[arr.length-1].toLowerCase();if(text!="zip"){return getIi18NText("upload_type_denied")}else{return true}},listeners:{}},{xtype:"radiogroup",fieldLabel:getIi18NText("jsp_setDefault"),allowBlank:false,columns:2,vertical:false,defaults:{margin:"0 5 0 5",name:"isDefault"},items:[{boxLabel:getIi18NText("yes"),inputValue:"1",checked:true},{boxLabel:getIi18NText("no"),inputValue:"0"}]}],buttons:[{text:getIi18NText("reset"),handler:function(){var form=this.up("form").getForm();form.reset()}},{text:getIi18NText("complete"),formBind:true,disabled:true,handler:function(){var versionName=Ext.getCmp("versionName").getValue();var result=checkVersionName("system!checkFirmwareName.action",versionName);if(result==-1){Ext.Msg.alert(getIi18NText("systemMessage"),getIi18NText("repeatApkEdition"));return}var form=this.up("form").getForm();if(form.isValid()){Ext.getBody().mask(getIi18NText("upload_uploadding"));form.submit({success:function(form,action){Ext.getBody().unmask();var code=action.result.code;var msg=getIi18NText("fail");if(code!=5){addNewAppWin.hide()}else{addNewAppWin.show()}switch(code){case 0:tabStore.loadPage(1);msg=getIi18NText("saveSuccess");break;case 1:msg=getIi18NText("jsp_selectFile");break;case 2:msg=getIi18NText("upload_paramerror");break;case 3:msg=getIi18NText("jsp_fileError");break;case 4:msg=getIi18NText("capacityDisable");break;default:break}Ext.Msg.alert(getIi18NText("systemMessage"),msg)},failure:function(form,action){Ext.getBody().unmask();Ext.Msg.alert(getIi18NText("systemMessage"),getIi18NText("fail"))}})}}}]}});updatefirmware=function(id,opt){if("delete"==opt){Ext.Msg.show({icon:Ext.MessageBox.QUESTION,title:getIi18NText("systemMessage"),cls:"msgCls",msg:getIi18NText("jsp_confirmDelete"),plain:true,buttons:Ext.MessageBox.OKCANCEL,buttonText:{ok:getIi18NText("monitor_message_55"),cancel:getIi18NText("monitor_message_32")},fn:function(bid){if(bid=="ok"){Ext.Ajax.request({url:"system!updateFirmware.action",params:{id:id,opt:opt},method:"GET",success:function(response,options){var result=eval("("+response.responseText+")");if(result.code==0){tabStore.loadPage(1)}},failure:function(response,options){Ext.MessageBox.alert(getIi18NText("fail"),getIi18NText("timeout"))}})}}})}else{Ext.Ajax.request({url:"system!updateFirmware.action",params:{id:id,opt:opt},method:"GET",success:function(response,options){var result=eval("("+response.responseText+")");if(result.code==0){tabStore.loadPage(1)}},failure:function(response,options){Ext.MessageBox.alert(getIi18NText("fail"),getIi18NText("timeout"))}})}};function renderOperation(value,metaData,record,rIndex,cIndex){var id=record.get("id");var isDefault=record.get("isDefault");var ctrlHtml=['<ul class="ctrlULCls">'];if(AUTH["delete"]){ctrlHtml.push('<li><span class="">&nbsp;</span><a href="javascript: updatefirmware('+id+",'delete');\" title=\""+getIi18NText("delete")+'">'+getIi18NText("delete")+"</a></li>")}if("0"==isDefault){ctrlHtml.push('<li><span class="">&nbsp;</span><a href="javascript: updatefirmware('+id+",'default');\" title=\""+getIi18NText("jsp_default")+'">'+getIi18NText("jsp_default")+"</a></li>")}else{if("1"==isDefault){ctrlHtml.push('<li><span class="">&nbsp;</span><a href="javascript: updatefirmware('+id+",'noDefault');\" title=\""+getIi18NText("jsp_noDefault")+'">'+getIi18NText("jsp_noDefault")+"</a></li>")}}ctrlHtml.push("</ul>");return ctrlHtml.join("")}function renderVersion(value,metaData,record,rIndex,cIndex){return versionMap.get(value)}function renderDefault(value,metaData,record,rIndex,cIndex){if(value==1){return getIi18NText("yes")}else{return getIi18NText("no")}}function showTip(comp,msg){commonTip.update(msg);commonTip.showBy(comp,null,[50,-60]);comp.addListener("mouseout",function(){commonTip.hide()})}});