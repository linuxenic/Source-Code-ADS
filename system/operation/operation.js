var defaultSelect;Ext.onReady(function(){var viewport,tabStore,ajaxProxy,gridPanel,gridRowFix="grid_row_";var isEng=window.top.getIi18NText("confirm")=="OK"?true:false;viewport=Ext.create("Ext.container.Viewport",{layout:"border",renderTo:Ext.getBody(),border:false,style:"background:white",items:[{region:"north",height:40,width:400,id:"northContanier",layout:{type:"hbox",align:"middle",defaultMargins:{right:3}},bodyCls:"x_panel_backDD",items:[{xtype:"image",src:"",width:40,height:24,imgCls:"searchIconCss"},{fieldLabel:window.top.getIi18NText("name"),id:"searchTextId",labelAlign:"right",xtype:"textfield",maxLength:60,width:200,labelWidth:40,emptyText:getIi18NText("account")+"、"+getIi18NText("nickname"),enforceMaxLength:true},{xtype:"datefield",fieldLabel:getIi18NText("companyInfo10"),margin:"8 0 5 8",name:"btime",labelWidth:isEng==true?66:40,editable:false,format:"Y/m/d",width:isEng==true?175:150,id:"btime",emptyText:getIi18NText("startTime")},{xtype:"datefield",name:"etime",labelWidth:50,margin:"0 7 0 2",id:"etime",width:110,editable:false,format:"Y/m/d",emptyText:getIi18NText("endTime")},{xtype:"button",id:"queryBut",iconCls:"queryIconCss",text:window.top.getIi18NText("select"),handler:queryFun}]},{region:"center",border:false,layout:"fit",listeners:{render:renderTable}}]});var commonTip=Ext.create("Ext.tip.ToolTip",{title:window.top.getIi18NText("systemMessage"),minWidth:100,html:""});Ext.QuickTips.init();var AUTH=Ext.merge({add:false,"delete":false},Ext.decode(decode(AUTH_TBAR)));function renderTable($this,eopt){ajaxProxy=getAjaxProxy({url:"system!allSystemLog.action"});tabStore=Ext.create("Ext.data.Store",{fields:["id","username","nickName","operation","time"],buffered:false,pageSize:30,leadingBufferZone:50,proxy:ajaxProxy,autoLoad:true,sorters:[{property:"time",direction:"DESC",}],listeners:{load:function($this){Ext.getCmp("totalLogTabRows").setValue($this.getTotalCount());Ext.getBody().unmask()}}});gridPanel=Ext.create("Ext.grid.Panel",{title:window.top.getIi18NText("operationLogList"),iconCls:"tabIconCss",frame:false,shadow:false,loadMask:false,store:tabStore,selModel:{mode:"MULTI",allowDeselect:false,enableKeyNav:false},columns:[{text:window.top.getIi18NText("No"),width:80,xtype:"rownumberer",align:"center"},{text:window.top.getIi18NText("username"),dataIndex:"username",minWidth:70},{text:window.top.getIi18NText("nickname"),dataIndex:"nickName",minWidth:70},{text:window.top.getIi18NText("operate"),dataIndex:"operation",minWidth:400},{text:window.top.getIi18NText("time"),dataIndex:"time",minWidth:200}],bbar:[{xtype:"pagingtoolbar",store:tabStore,border:false,displayInfo:true}],margin:1,tools:[{xtype:"displayfield",id:"totalLogTabRows",fieldLabel:window.top.getIi18NText("countOfLogs"),labelWidth:50,minWidth:90,value:"-"},{xtype:"button",id:"refreshLogs",tooltip:window.top.getIi18NText("refreshLogsInfo"),tooltipType:"title",text:window.top.getIi18NText("refresh"),border:false,iconCls:"refreshIconCss",margin:"0 5 0 0",handler:refreshData},{xtype:"button",id:"export",tooltipType:"title",text:window.top.getIi18NText("export"),border:false,margin:"0 5 0 0",handler:exportLogs}]});$this.add(gridPanel);function refreshData(){if(tabStore){tabStore.loadPage(1)}}function exportLogs(){if(tabStore.data.length==0){Ext.Msg.alert(getIi18NText("systemMessage"),getIi18NText("jsp_noExportData"));return}Ext.getBody().mask(getIi18NText("monitor_message_58"));var params=tabStore.proxy.extraParams;console.info("params,",params);Ext.Ajax.request({url:"system!exportSystemLogs.action",timeout:3600000,params:params,async:false,success:function(response){Ext.getBody().unmask();var text=eval("("+response.responseText+")");if(text.code=="0"){window.location.href=getWebPath()+"/page/statistics/statistics/export/"+text.msg}else{Ext.Msg.alert(getIi18NText("systemMessage"),text.msg);return}},failure:function(response){Ext.Msg.alert(getIi18NText("systemMessage"),getIi18NText("timeout"));Ext.getBody().unmask()}})}}function queryFun(but){var btime=Ext.getCmp("btime");if(!btime.isValid()){showTip(but,window.top.getIi18NText("startTimeErr"));return}var etime=Ext.getCmp("etime");if(!etime.isValid()){showTip(but,window.top.getIi18NText("endTimeErr"));return}if(!Ext.isEmpty(etime.getValue())&&!Ext.isEmpty(btime.getValue())){if(btime.getValue()>etime.getValue()){showTip(but,window.top.getIi18NText("timesErrWarming"));return}}ajaxProxy.setExtraParam("n",encode(Ext.getCmp("searchTextId").getValue()));ajaxProxy.setExtraParam("b",Ext.Date.format(btime.getValue(),dateFormat));ajaxProxy.setExtraParam("e",Ext.Date.format(etime.getValue(),"Y/m/d 23:59:59"));tabStore.loadPage(1)}function showTip(comp,msg){commonTip.update(msg);commonTip.showBy(comp,null,[50,-60]);comp.addListener("mouseout",function(){commonTip.hide()})}});