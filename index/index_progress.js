var puListWinow;var gridPanel,programStore,store,ctrlTrUl="ctrlTrUl_prefix_";var editSingleRowFn;var freshPlanTimeout;var c=1;var clientWindth=$(window.top).width();var clientHeight=$(window.top).height();var isOpenjin=false;function getAjaxProxy(a){return new Ext.data.proxy.Ajax(Ext.merge({type:"ajax",url:"",reader:{type:"json",root:"data",totalProperty:"totalCount"},tiemout:20000,simpleSortMode:false,extraParams:{},filterParam:"query",listeners:{exception:function(f,d,b,e){showResult(false,d)}}},a))}function showResult(f,b){var a;if(b.timedout==true){Ext.Msg.alert(getIi18NText("systemMessage"),getIi18NText("timeout")+"<br/><font color='red'>("+getIi18NText("dealTimeoutTip01")+")</font>");return false}var a;try{a=Ext.decode(b.responseText)}catch(d){Ext.Msg.alert(getIi18NText("systemMessage"),getIi18NText("loginTimeoutTip01"),function(){window.location.replace("auth!logOffUser.action")});return false}if(!a||f==false){Ext.Msg.alert(getIi18NText("systemMessage"),getIi18NText("dataError")+"<br/><font color='red'>("+getIi18NText("dataErrorTip")+")</font>");return false}if(a.code!=0){Ext.Msg.alert(getIi18NText("systemMessage"),a.msg);return false}return a}function dianDown(a){if(a==1){$("#daDo").css("color","#C30")}else{$("#lisss").css("color","#C30")}}function dianUp(){$("#lisss").css("color","#fff")}function resizeChildContent(){Ext.each(Ext.ComponentQuery.query("panel[id^="+ctrlTrUl+"]"),function(a){if(a.isVisible()){a.doLayout()}})}function rangeRenderFn(f,d,b,e,a){return f.replace("~","<br/>"+getIi18NText("to")+"<br/>")}function clearUnuseCmp(){Ext.each(Ext.ComponentQuery.query("panel[id^="+ctrlTrUl+"]"),function(a){a.removeAll();if(typeof(a.getEl())!="undefined"){a.getEl().remove()}Ext.ComponentManager.unregister(a)})}var recordIds=new Ext.util.MixedCollection();function refreshPlanDownloadStatus(){window.clearTimeout(freshPlanTimeout);freshPlanTimeout=window.setInterval(function(){refreshPlanGridProcess()},3000)}function refreshPlanGridProcess(){isOpenjin=true;var a=20;var b=(tabStore.currentPage-1)*a;Ext.Ajax.request({url:"item!publishTaskList.action",params:{page:tabStore.currentPage,start:b,limit:a,n:"",b:null,e:null},method:"post",timeout:120000,callback:function(e,l,h){Ext.getBody().unmask();var n=h.responseText;var d=Ext.JSON.decode(n).data;var m=Ext.JSON.decode(n).totalCount;if(Ext.JSON.decode(n).totalCount==0){window.clearInterval(freshPlanTimeout)}else{for(var g=0;g<d.length;g++){tabStore.getAt(g).set("topercents",d[g].topercents);if(typeof(Ext.getCmp(ctrlTrUl+g+"_grter"))!="undefined"){var j=d[g].terinfo;for(var f=0;f<j.length;f++){Ext.getCmp(ctrlTrUl+g+"_grter").getStore().each(function(i){if(i.get("tid")==j[f].tid){i.set("jd",j[f].jd)}})}}}}}})}function refreFn(){isOpenjin=false;window.clearInterval(freshPlanTimeout);tabStore.load();refreshPlanDownloadStatus()}function paiqiFn(){if(puListWinow&&puListWinow.isPanel){puListWinow.destroy()}var a=getAjaxProxy({url:"item!publishTaskList.action",extraParams:{n:"",b:null,e:null}});tabStore=Ext.create("Ext.data.Store",{fields:["id","name","type","playRange","createDate","author","terId","topercents"],buffered:false,pageSize:20,leadingBufferZone:50,proxy:a,autoLoad:true,listeners:{load:function(b){Ext.getCmp("totalTabRows").setValue(b.getTotalCount());clearUnuseCmp()}}});gridPanel=Ext.create("Ext.grid.Panel",{shadow:true,store:tabStore,height:512,columns:{items:[{text:getIi18NText("No"),width:60,xtype:"rownumberer",align:"center"},{text:getIi18NText("publishName"),dataIndex:"name",flex:1,minWidth:100},{text:getIi18NText("type"),dataIndex:"type",width:60},{text:getIi18NText("playingStartTime"),dataIndex:"playRange",minWidth:150,renderer:rangeRenderFn},{text:getIi18NText("createTime"),dataIndex:"createDate",minWidth:140},{text:getIi18NText("creator"),dataIndex:"author",minWidth:60},{text:getIi18NText("toProgress"),dataIndex:"topercents",renderer:function(d,b){b.css="x-grid-back-red";return d},minWidth:60},{text:getIi18NText("operation"),dataIndex:"id",minWidth:150,menuText:getIi18NText("operation"),menuDisabled:true,sortable:false,draggable:false,resizable:false,renderer:ctrlRenderFn},{text:"",dataIndex:"terId",resizable:false,hidden:true}],defaults:{menuDisabled:true,sortable:false}},bbar:[{id:"padingBar",xtype:"pagingtoolbar",store:tabStore,border:false,displayInfo:true,listeners:{beforechange:function(b,f,d){c=f}}}],dockedItems:[{xtype:"toolbar",dock:"top",baseCls:"x_panel_backDD",items:[{xtype:"displayfield",id:"totalTabRows",fieldLabel:getIi18NText("countOfPublish"),labelWidth:70,margin:"0 0 0 30",width:130,value:"-"},{xtype:"splitter",width:10},{xtype:"button",tooltip:getIi18NText("item_refresh_schedule"),text:getIi18NText("refresh"),border:false,iconCls:"refreshIconCss",margin:"0 0 0 620",handler:function(){refreFn()}}]}],listeners:{resize:resizeChildContent},viewConfig:{trackOver:false,disableSelection:true,emptyText:'<h1 style="margin:10px; font-size: 18px;">'+getIi18NText("item_noresult")+"</h1>"}});puListWinow=Ext.create("Ext.window.Window",{title:getIi18NText("schedulingTaskList"),modal:true,floating:true,draggable:true,closable:true,border:true,shadowOffset:10,shadow:"drop",renderTo:document.body,height:550,width:900,layout:{type:"vbox"},items:[{xtype:"panel",width:"100%",height:520,border:0,items:[gridPanel]}],listeners:{close:function(b){recordIds.clear();window.clearInterval(freshPlanTimeout);isOpenjin=false;c=1}}});puListWinow.show();refreshPlanDownloadStatus()}editSingleRowFn=function(a,k,h,d){var g=gridPanel.getStore().getAt(a);if(g){var i=Ext.get(ctrlTrUl+a).parent("tr");var j=ctrlTrUl+a+"_div";var e=ctrlTrUl+a+"_panel";var b=Ext.getCmp(e);var f=Ext.get(ctrlTrUl+a).query(".viewIconACss")[0];f.innerHTML=getIi18NText("item_up");if(b!=null&&k=="V"){b.setVisible(!b.isVisible());if(!b.isVisible()){f.innerHTML=getIi18NText("detailSchedule")}gridPanel.doLayout();b.doLayout();return}if(k!="V"){reqInnerContent(b,g.get("id"),a,h,d);return}i.insertSibling('<tr><td colspan=12 id="'+j+'" ></td></tr>',"after");b=Ext.create("Ext.panel.Panel",{id:e,height:260,border:false,header:false,renderTo:Ext.get(j),layout:"hbox",baseCls:"childContentCls",items:[{flex:1,itemId:"program",height:"100%",layout:"fit",padding:1,border:false},{flex:1,itemId:"terminal",height:"100%",layout:"fit",padding:1,border:false}],listeners:{afterrender:function(l){reqInnerContent(l,g.get("id"),a,h,d)}}})}};function ctrlRenderFn(g,d,b,f,a){var e=['<ul class="ctrlULCls" id="'+ctrlTrUl+f+'">'];e.push('<input type="hidden" class="rIndex" name="rIndex"  value="'+f+'"/>');if(!isOpenjin){e.push('<li><span class="viewIconCss">&nbsp;</span><a  href="javascript: editSingleRowFn('+f+",'V',0,1);\" title="+getIi18NText("item_detail_info")+' class="viewIconACss">'+getIi18NText("detailSchedule")+"</a></li>")}else{if(typeof(Ext.getCmp(ctrlTrUl+f+"_grter"))!="undefined"){var h=Ext.get(ctrlTrUl+f).query(".viewIconACss")[0];e.push('<li><span class="viewIconCss">&nbsp;</span><a  href="javascript: editSingleRowFn('+f+",'V',0,1);\" title="+getIi18NText("item_detail_info")+' class="viewIconACss">'+h.innerHTML+"</a></li>")}else{e.push('<li><span class="viewIconCss">&nbsp;</span><a  href="javascript: editSingleRowFn('+f+",'V',0,1);\" title="+getIi18NText("item_detail_info")+' class="viewIconACss">'+getIi18NText("detailSchedule")+"</a></li>")}}e.push("</ul>");return e.join("")}function reqInnerContent(d,a,b,e,f){d.getEl().mask(getIi18NText("item_loading"));Ext.Ajax.request({url:"item!showPlanList.action",params:{pubId:a,schedule:e,start:f},method:"post",timedout:180000,callback:function(h,i,g){d.getEl().unmask();setTableStore(d,g,b);gridPanel.doLayout()}})}function setTableStore(b,f,h){if(f.timedout==true){Ext.Msg.alert(getIi18NText("systemMessage"),getIi18NText("timeout")+"<br/><font color='red'>("+getIi18NText("dealTimeoutTip01")+")</font>");return false}var a;try{a=Ext.decode(f.responseText)}catch(i){Ext.Msg.alert(getIi18NText("systemMessage"),getIi18NText("loginTimeoutTip01"),function(){window.location.replace("auth!logOffUser.action")});return false}$("input[name='pageIndexs']").val(a.start);$("input[name='scheduleStatuss']").val(a.schedule);programStore=Ext.create("Ext.data.Store",{data:a.p,fields:["u","n","s","t","l","programId"],groupField:"u"});program=Ext.create("Ext.grid.Panel",{title:getIi18NText("programInfo"),store:programStore,features:[{id:"group",ftype:"groupingsummary",groupHeaderTpl:['<font color="red">{name}</font>'],hideGroupedHeader:true,collapsible:true,enableGroupingMenu:false}],columns:[{header:getIi18NText("item_program"),minWidth:100,flex:1,dataIndex:"n",summaryType:"count",renderer:pnameRenderFn,summaryRenderer:function(l,e,k){return((l==0||l>1)?'<font color="gray">('+l+getIi18NText("pub_his_pro_count")+")</font>":'<font color="gray">(1 '+getIi18NText("pub_his_pro_count")+")</font>")}},{text:getIi18NText("screen"),width:80,dataIndex:"s"},{text:getIi18NText("duration"),width:80,dataIndex:"l"},{text:getIi18NText("item_times"),width:40,flex:1,dataIndex:"t"}],listeners:{beforeitemclick:function(){return false},beforecellmousedown:function(){return false},mouseover:function(k){k.stopEvent()},rowmousedown:function(l,k,m){m.stopEvent()}},viewConfig:{trackOver:false,disableSelection:true,emptyText:'<h1 style="margin:10px; font-size: 18px;">'+getIi18NText("item_noresult")+"</h1>"}});b.queryById("program").add(program);var j=ctrlTrUl+h+"_grter";store=Ext.create("Ext.data.Store",{data:a.t,fields:["n","s","i","jd","tid"]});var g=getIi18NText("terminalInfo");if(stmver){if(stmver=="Self-selling"){g=getIi18NText("deviceInfo")}}var d=Ext.create("Ext.grid.Panel",{id:j,title:g+"<a href='javascript:void(0);' class='aAll' onclick='scheduleStatus(this,0,1);' style='margin-left:35px;color:black;"+(a.schedule=="0"?"text-decoration:underline":"")+"'>"+getIi18NText("wp_total")+"("+a.count+")</a>&nbsp;&nbsp;<a href='javascript:void(0);' class='aSuccess' onclick='scheduleStatus(this,1,1);'  style='color:green;"+(a.schedule=="1"?"text-decoration:underline":"")+"''>"+getIi18NText("pubHistory07")+"&nbsp;&nbsp;("+a.count100+")<a/>&nbsp;&nbsp;<a href='javascript:void(0);' class='aFail' onclick='scheduleStatus(this,2,1);' style='color:red;"+(a.schedule=="2"?"text-decoration:underline":"")+"''>"+getIi18NText("pubHistory01")+"&nbsp;&nbsp;("+a.countNot100+")<a/>",disableSelection:true,remoteSort:true,store:store,columns:[{text:getIi18NText("No"),width:40,xtype:"rownumberer",align:"center"},{text:"",width:40,xtype:"rownumberer",hidden:true,dataIndex:"tid",},{text:getIi18NText("name"),flex:1,minWidth:80,dataIndex:"n",},{text:getIi18NText("item_dpi"),width:80,dataIndex:"s",},{text:getIi18NText("upload_percent"),flex:1,renderer:function(k,e){e.css="x-grid-back-red";return k},minWidth:50,dataIndex:"jd"},{text:"IP",flex:1,minWidth:80,dataIndex:"i"}],bbar:[{fieldLabel:"",id:"pageIndex",name:"pageIndexs",xtype:"hidden",value:"1"},{fieldLabel:"",id:"scheduleStatus",name:"scheduleStatuss",xtype:"hidden",value:"0"},{text:getIi18NText("prePage"),disabled:a.start=="1",handler:function(){$("input[name='pageIndexs']").val(a.start);$("input[name='scheduleStatuss']").val(a.schedule);scheduleStatus(Ext.getCmp(j).body.dom,$("input[name='scheduleStatuss']").val(),Number($("input[name='pageIndexs']").val())-1)}},"-",{text:getIi18NText("nextPage"),disabled:a.start==a.totalCount||a.totalCount=="0",handler:function(){$("input[name='pageIndexs']").val(a.start);$("input[name='scheduleStatuss']").val(a.schedule);scheduleStatus(Ext.getCmp(j).body.dom,$("input[name='scheduleStatuss']").val(),Number($("input[name='pageIndexs']").val())+1)}},{text:getIi18NText("currentPage")+":"+(a.totalCount=="0"?"0,":a.start+","),xtype:"tbtext",},{text:getIi18NText("totalPage")+" "+a.totalCount+" "+getIi18NText("page"),xtype:"tbtext",}],listeners:{beforeitemclick:function(){return false},beforedeselect:function(){return false}},viewConfig:{trackOver:false,disableSelection:true,emptyText:'<h1 style="margin:10px; font-size: 18px;">'+getIi18NText("item_noresult")+"</h1>"}});b.queryById("terminal").add(d)}function pnameRenderFn(f,d,b,e,a){if(f==null){return'<font color="glay">--</font>'}return Ext.String.format('<a class="pnameCss"  title='+getIi18NText("previewProgram")+' href="javascript: preProgramFn('+e+",'P');\">{0}</a>",Ext.String.htmlEncode(f))}preProgramFn=function(g,i){var e=program.getStore().getAt(g);if(e){var d=e.get("programId");var h=e.get("n");var f=e.get("t");var b=e.get("s");var a=b.split("*");clientWindth=$(window.top).width();clientHeight=$(window.top).height();Ext.Ajax.request({url:"item!setPreviewJsonItem.action",params:{programId:d,proWidth:clientWindth,proHeight:clientHeight},method:"post",timeout:180000,callback:function(m,s,q){Ext.getBody().unmask();if(q.timedout==true){Ext.Msg.alert(getIi18NText("systemMessage"),getIi18NText("timeout")+"<br/><font color='red'>("+getIi18NText("dealTimeoutTip01")+")</font>");return}var u;try{u=Ext.decode(q.responseText);var l=Number(a[0]);var t=Number(a[1]);var j=clientWindth;var k=clientHeight;var r=1;if((j>=l)&&(k>=t)){r=0.8}else{if((j>=l)&&(k<=t)){r=k/(t*1.5)}else{if((j<=l)&&(k>=t)){r=j/(l*1.5)}else{var o=j/(l*1.5);var n=k/(t*1.5);r=o<n?o:n}}}top.Ext.create("Ext.window.Window",{id:"activePreviewWindow",title:getIi18NText("item_pre_prgram")+h,frame:false,width:l*r+14,height:t*r+44,modal:true,cloasable:true,layout:"fit",items:[{id:"activePreviwPanel",html:'<iframe frameborder="0" width="100%" height="100%" src="item!activePreview.action"></iframe>'}]}).show()}catch(p){Ext.Msg.alert(getIi18NText("systemMessage"),getIi18NText("loginTimeoutTip01"),function(){window.location.replace("auth!logOffUser.action")});return}if(!u||s==false){Ext.Msg.alert(getIi18NText("systemMessage"),getIi18NText("dataError")+"<br/><font color='red'>("+getIi18NText("dealTimeoutTip01")+")</font>");return}}})}};function scheduleStatus(d,e,f){var b=$(d).parents("tr").eq(0).prev().find(".rIndex").val();var a=gridPanel.getStore().getAt(b);editSingleRowFn(b,"S",e,f)};